<?xml version="1.0" encoding="UTF-8"?>
<NikuDataBus xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../xsd/nikuxog_contentPack.xsd">
	<Header action="write" externalSource="NIKU" objectType="contentPack" version="8.0"/>
	<contentPack update="true">
		<Processes>
			<Process allowOneRunningInstance="true" code="cpc_to_update" createdBy="admin" endStep="Finish" source="customer" startEvent="update"
    startOption="AUTO_START" startStep="Start">
				<nls languageCode="ca" name="CPC - Flag Tasks to Update"/>
				<nls languageCode="cs" name="CPC - Flag Tasks to Update"/>
				<nls languageCode="da" name="CPC - Flag Tasks to Update"/>
				<nls languageCode="de" name="CPC - Flag Tasks to Update"/>
				<nls description="Flag tasks which need to re-calculate  the % Complete attribute" languageCode="en" name="CPC - Flag Tasks to Update"/>
				<nls languageCode="es" name="CPC - Flag Tasks to Update"/>
				<nls languageCode="fi" name="CPC - Flag Tasks to Update"/>
				<nls languageCode="fr" name="CPC - Flag Tasks to Update"/>
				<nls languageCode="hu" name="CPC - Flag Tasks to Update"/>
				<nls languageCode="it" name="CPC - Flag Tasks to Update"/>
				<nls languageCode="ja" name="CPC - Flag Tasks to Update"/>
				<nls languageCode="ko" name="CPC - Flag Tasks to Update"/>
				<nls languageCode="nl" name="CPC - Flag Tasks to Update"/>
				<nls languageCode="no" name="CPC - Flag Tasks to Update"/>
				<nls languageCode="pl" name="CPC - Flag Tasks to Update"/>
				<nls description="Marca tarefas que precisam recalcular o % Concluído" languageCode="pt" name="CPC - Marca Tarefas para Atualização"/>
				<nls languageCode="ru" name="CPC - Flag Tasks to Update"/>
				<nls languageCode="sv" name="CPC - Flag Tasks to Update"/>
				<nls languageCode="tr" name="CPC - Flag Tasks to Update"/>
				<nls languageCode="zh" name="CPC - Flag Tasks to Update"/>
				<nls languageCode="zh_TW" name="CPC - Flag Tasks to Update"/>
				<StartCondition><![CDATA[(task.prduration != task.cpc_duration || task.prpctcomplete != task.prpctcomplete__oldValue || task.cpc_exclude != task.cpc_exclude__oldValue) && task.cpc_update == 0 && task.has_subtasks == 0 && task.cpc_duration != null]]></StartCondition>
				<Security>
					<UserSecurity rightCode="PROCESS-DEF-INST-INITIATE" userName="admin"/>
					<UserSecurity rightCode="PROCESS-DEF-INST-WRITE" userName="admin"/>
				</Security>
				<Objects>
					<Object manualStart="true" name="t" objectType="task" partitionCode="NIKU.ROOT" partitionModeCode="PARTITION_AND_ANSTRS_DESDNTS" type="BPM_POT_PRIMARY"/>
				</Objects>
				<Steps>
					<Step id="Start" isMileStone="false" sequenceNo="1">
						<nls languageCode="ca" name="Start"/>
						<nls languageCode="cs" name="Start"/>
						<nls languageCode="da" name="Start"/>
						<nls languageCode="de" name="Start"/>
						<nls languageCode="en" name="Start"/>
						<nls languageCode="es" name="Start"/>
						<nls languageCode="fi" name="Start"/>
						<nls languageCode="fr" name="Start"/>
						<nls languageCode="hu" name="Start"/>
						<nls languageCode="it" name="Start"/>
						<nls languageCode="ja" name="Start"/>
						<nls languageCode="ko" name="Start"/>
						<nls languageCode="nl" name="Start"/>
						<nls languageCode="no" name="Start"/>
						<nls languageCode="pl" name="Start"/>
						<nls languageCode="pt" name="Início"/>
						<nls languageCode="ru" name="Start"/>
						<nls languageCode="sv" name="Start"/>
						<nls languageCode="tr" name="Start"/>
						<nls languageCode="zh" name="Start"/>
						<nls languageCode="zh_TW" name="Start"/>
						<Notifications notifyOwner="false">
							<NotifyWhen stepCompleted="false" stepInError="false" stepStarted="false"/>
							<Assignees/>
						</Notifications>
						<Operations/>
						<TransitionRestrictions>
							<TransitionRestriction>
								<Join type="BPM_JT_NONE">
									<Condition sequencNo="1" type="BPM_SCT_PRECONDITION"/>
								</Join>
							</TransitionRestriction>
							<TransitionRestriction>
								<Split type="BPM_ST_SEQUENCE">
									<Condition sequencNo="1" type="BPM_SCT_POSTCONDITION">
										<Transitions>
											<Transition to="cpc_flag_task"/>
										</Transitions>
									</Condition>
								</Split>
							</TransitionRestriction>
						</TransitionRestrictions>
					</Step>
					<Step id="Finish" isMileStone="false" sequenceNo="2">
						<nls languageCode="ca" name="Finish"/>
						<nls languageCode="cs" name="Finish"/>
						<nls languageCode="da" name="Finish"/>
						<nls languageCode="de" name="Finish"/>
						<nls languageCode="en" name="Finish"/>
						<nls languageCode="es" name="Finish"/>
						<nls languageCode="fi" name="Finish"/>
						<nls languageCode="fr" name="Finish"/>
						<nls languageCode="hu" name="Finish"/>
						<nls languageCode="it" name="Finish"/>
						<nls languageCode="ja" name="Finish"/>
						<nls languageCode="ko" name="Finish"/>
						<nls languageCode="nl" name="Finish"/>
						<nls languageCode="no" name="Finish"/>
						<nls languageCode="pl" name="Finish"/>
						<nls languageCode="pt" name="Fim"/>
						<nls languageCode="ru" name="Finish"/>
						<nls languageCode="sv" name="Finish"/>
						<nls languageCode="tr" name="Finish"/>
						<nls languageCode="zh" name="Finish"/>
						<nls languageCode="zh_TW" name="Finish"/>
						<Notifications notifyOwner="false">
							<NotifyWhen stepCompleted="false" stepInError="false" stepStarted="false"/>
							<Assignees/>
						</Notifications>
						<Operations/>
						<TransitionRestrictions>
							<TransitionRestriction>
								<Join type="BPM_JT_NONE">
									<Condition sequencNo="1" type="BPM_SCT_PRECONDITION"/>
								</Join>
							</TransitionRestriction>
							<TransitionRestriction>
								<Split type="BPM_ST_SEQUENCE">
									<Condition sequencNo="1" type="BPM_SCT_POSTCONDITION">
										<Transitions/>
									</Condition>
								</Split>
							</TransitionRestriction>
						</TransitionRestrictions>
					</Step>
					<Step id="cpc_flag_task" isMileStone="false" sequenceNo="3">
						<nls languageCode="ca" name="Flag Task"/>
						<nls languageCode="cs" name="Flag Task"/>
						<nls languageCode="da" name="Flag Task"/>
						<nls languageCode="de" name="Flag Task"/>
						<nls languageCode="en" name="Flag Task"/>
						<nls languageCode="es" name="Flag Task"/>
						<nls languageCode="fi" name="Flag Task"/>
						<nls languageCode="fr" name="Flag Task"/>
						<nls languageCode="hu" name="Flag Task"/>
						<nls languageCode="it" name="Flag Task"/>
						<nls languageCode="ja" name="Flag Task"/>
						<nls languageCode="ko" name="Flag Task"/>
						<nls languageCode="nl" name="Flag Task"/>
						<nls languageCode="no" name="Flag Task"/>
						<nls languageCode="pl" name="Flag Task"/>
						<nls languageCode="pt" name="Marca Tarefa"/>
						<nls languageCode="ru" name="Flag Task"/>
						<nls languageCode="sv" name="Flag Task"/>
						<nls languageCode="tr" name="Flag Task"/>
						<nls languageCode="zh" name="Flag Task"/>
						<nls languageCode="zh_TW" name="Flag Task"/>
						<Notifications notifyOwner="false">
							<NotifyWhen stepCompleted="false" stepInError="false" stepStarted="false"/>
							<Assignees/>
						</Notifications>
						<Operations>
							<Action code="cpc_flag" objectMethod="cpc_update" objectName="t" type="BPM_SAT_SYSTEM">
								<nls languageCode="ca" name="Flag Task"/>
								<nls languageCode="cs" name="Flag Task"/>
								<nls languageCode="da" name="Flag Task"/>
								<nls languageCode="de" name="Flag Task"/>
								<nls description="Set cpc_update to 1" languageCode="en" name="Flag Task"/>
								<nls languageCode="es" name="Flag Task"/>
								<nls languageCode="fi" name="Flag Task"/>
								<nls languageCode="fr" name="Flag Task"/>
								<nls languageCode="hu" name="Flag Task"/>
								<nls languageCode="it" name="Flag Task"/>
								<nls languageCode="ja" name="Flag Task"/>
								<nls languageCode="ko" name="Flag Task"/>
								<nls languageCode="nl" name="Flag Task"/>
								<nls languageCode="no" name="Flag Task"/>
								<nls languageCode="pl" name="Flag Task"/>
								<nls description="Atualiza o campo cpc_update para 1" languageCode="pt" name="Marcar Tarefa"/>
								<nls languageCode="ru" name="Flag Task"/>
								<nls languageCode="sv" name="Flag Task"/>
								<nls languageCode="tr" name="Flag Task"/>
								<nls languageCode="zh" name="Flag Task"/>
								<nls languageCode="zh_TW" name="Flag Task"/>
								<ActionParams>
									<Param name="value" value="1"/>
								</ActionParams>
								<Notifications notifyOwner="false">
									<NotifyWhen stepActionInError="false" stepActionPerformed="false"/>
									<Assignees/>
								</Notifications>
							</Action>
						</Operations>
						<TransitionRestrictions>
							<TransitionRestriction>
								<Join type="BPM_JT_NONE">
									<Condition sequencNo="1" type="BPM_SCT_PRECONDITION"/>
								</Join>
							</TransitionRestriction>
							<TransitionRestriction>
								<Split type="BPM_ST_SEQUENCE">
									<Condition sequencNo="1" type="BPM_SCT_POSTCONDITION">
										<Transitions>
											<Transition to="Finish"/>
										</Transitions>
									</Condition>
								</Split>
							</TransitionRestriction>
						</TransitionRestrictions>
					</Step>
				</Steps>
				<Groups/>
				<OBSAssocs complete="false"/>
			</Process>
			<Process allowOneRunningInstance="true" code="cpc_calc_duration" createdBy="admin" endStep="Finish" source="customer" startOption="ON_DEMAND" startStep="Start">
				<nls languageCode="ca" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls languageCode="cs" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls languageCode="da" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls languageCode="de" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls
      description="Calculates % Complete for Summary Tasks and Projects which Custom % Complete Calculation Method is set to Duration. It excludes marked tasks from the calculation."
      languageCode="en" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls languageCode="es" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls languageCode="fi" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls languageCode="fr" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls languageCode="hu" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls languageCode="it" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls languageCode="ja" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls languageCode="ko" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls languageCode="nl" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls languageCode="no" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls languageCode="pl" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls
      description="Calcula o % Concluído de tarefas agregadoras e projetos cujo método de cálculo está configurado como Duração. Ele exclui do cálculo tarefas marcadas."
      languageCode="pt" name="CPC - Calcular % Concluído Personalizado - DURAÇÃO"/>
				<nls languageCode="ru" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls languageCode="sv" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls languageCode="tr" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls languageCode="zh" name="CPC - Calculate Custom % Complete - DURATION"/>
				<nls languageCode="zh_TW" name="CPC - Calculate Custom % Complete - DURATION"/>
				<Security>
					<UserSecurity rightCode="PROCESS-DEF-INST-INITIATE" userName="admin"/>
					<UserSecurity rightCode="PROCESS-DEF-INST-WRITE" userName="admin"/>
				</Security>
				<Objects>
					<Object manualStart="false" name="thisXmlDocument" objectType="xml_document" partitionCode="NIKU.ROOT" partitionModeCode="PARTITION_ONLY" type="BPM_POT_PRIMARY"/>
				</Objects>
				<Steps>
					<Step id="Start" isMileStone="false" sequenceNo="1">
						<nls languageCode="ca" name="Start"/>
						<nls languageCode="cs" name="Start"/>
						<nls languageCode="da" name="Start"/>
						<nls languageCode="de" name="Start"/>
						<nls languageCode="en" name="Start"/>
						<nls languageCode="es" name="Start"/>
						<nls languageCode="fi" name="Start"/>
						<nls languageCode="fr" name="Start"/>
						<nls languageCode="hu" name="Start"/>
						<nls languageCode="it" name="Start"/>
						<nls languageCode="ja" name="Start"/>
						<nls languageCode="ko" name="Start"/>
						<nls languageCode="nl" name="Start"/>
						<nls languageCode="no" name="Start"/>
						<nls languageCode="pl" name="Start"/>
						<nls languageCode="pt" name="Início"/>
						<nls languageCode="ru" name="Start"/>
						<nls languageCode="sv" name="Start"/>
						<nls languageCode="tr" name="Start"/>
						<nls languageCode="zh" name="Start"/>
						<nls languageCode="zh_TW" name="Start"/>
						<Notifications notifyOwner="false">
							<NotifyWhen stepCompleted="false" stepInError="false" stepStarted="false"/>
							<Assignees/>
						</Notifications>
						<Operations>
							<Action code="cpc_init" synchronized="true" type="BPM_SAT_CUSTOM">
								<nls languageCode="ca" name="Initializing Variables"/>
								<nls languageCode="cs" name="Initializing Variables"/>
								<nls languageCode="da" name="Initializing Variables"/>
								<nls languageCode="de" name="Initializing Variables"/>
								<nls description="Define xog user, log in to Clarity and stores the session ID in a persistent variable" languageCode="en" name="Initializing Variables"/>
								<nls languageCode="es" name="Initializing Variables"/>
								<nls languageCode="fi" name="Initializing Variables"/>
								<nls languageCode="fr" name="Initializing Variables"/>
								<nls languageCode="hu" name="Initializing Variables"/>
								<nls languageCode="it" name="Initializing Variables"/>
								<nls languageCode="ja" name="Initializing Variables"/>
								<nls languageCode="ko" name="Initializing Variables"/>
								<nls languageCode="nl" name="Initializing Variables"/>
								<nls languageCode="no" name="Initializing Variables"/>
								<nls languageCode="pl" name="Initializing Variables"/>
								<nls description="Define o usuário para XOG, faz login no Clarity e grava o Session ID em uma variável persistente" languageCode="pt" name="Inicializar Variáveis"/>
								<nls languageCode="ru" name="Initializing Variables"/>
								<nls languageCode="sv" name="Initializing Variables"/>
								<nls languageCode="tr" name="Initializing Variables"/>
								<nls languageCode="zh" name="Initializing Variables"/>
								<nls languageCode="zh_TW" name="Initializing Variables"/>
								<customScript languageCode="gel">
									<scriptText>
										<gel:script xmlns:core="jelly:core" xmlns:email="jelly:email" xmlns:file="jelly:com.niku.union.gel.FileTagLibrary"
                  xmlns:ftp="jelly:com.niku.union.gel.FTPTagLibrary" xmlns:gel="jelly:com.niku.union.gel.GELTagLibrary"
                  xmlns:soap="jelly:com.niku.union.gel.SOAPTagLibrary" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:sql="jelly:sql"
                  xmlns:xog="http://www.niku.com/xog" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
											<!-- Parameters -->
											<gel:parameter default="xog" var="xogUser"/>
											<!-- Debug: Set to 1 if you need to see debug messages or 0 if you don't (Don't let debug set to 1 in production) -->
											<core:set value="0" var="debug"/>
											<!-- Getting session ID for the user defined above (var xogUser) -->
											<core:new className="com.niku.union.security.DefaultSecurityIdentifier" var="securityId"/>
											<core:invokeStatic className="com.niku.union.security.UserSessionControllerFactory" method="getInstance" var="xogInstance"/>
											<core:set value="${xogInstance.init(xogUser, securityId)}" var="securityId"/>
											<core:set value="${securityId.getSessionId()}" var="sessionID"/>
											<!-- Checking if user can log in to Clarity -->
											<core:choose>
												<core:when test="${sessionID == null}">
													<gel:log level="error" message="Cannot log in to Clarity with user ${xogUser}!"/>
												</core:when>
												<core:otherwise>
													<core:if test="${ debug == 1 }">
														<gel:log level="debug" message="Logged in with user: ${xogUser}"/>
														<gel:log level="debug" message="Session ID: ${sessionID}"/>
													</core:if>
												</core:otherwise>
											</core:choose>
											<!-- Persistent variables -->
											<gel:persist scope="INSTANCE" value="${sessionID}" var="sessionID"/>
											<gel:persist scope="INSTANCE" value="${debug}" var="debug"/>
										</gel:script>
									</scriptText>
									<scriptParameter isSecure="false" name="xogUser" value="xog"/>
								</customScript>
								<Notifications notifyOwner="false">
									<NotifyWhen stepActionInError="false" stepActionPerformed="false" value="0"/>
									<Assignees/>
								</Notifications>
							</Action>
						</Operations>
						<TransitionRestrictions>
							<TransitionRestriction>
								<Join type="BPM_JT_NONE">
									<Condition sequencNo="1" type="BPM_SCT_PRECONDITION"/>
								</Join>
							</TransitionRestriction>
							<TransitionRestriction>
								<Split type="BPM_ST_SEQUENCE">
									<Condition sequencNo="1" type="BPM_SCT_POSTCONDITION">
										<Transitions>
											<Transition to="cpc_update_tasks"/>
										</Transitions>
									</Condition>
								</Split>
							</TransitionRestriction>
						</TransitionRestrictions>
					</Step>
					<Step id="Finish" isMileStone="false" sequenceNo="2">
						<nls languageCode="ca" name="Finish"/>
						<nls languageCode="cs" name="Finish"/>
						<nls languageCode="da" name="Finish"/>
						<nls languageCode="de" name="Finish"/>
						<nls languageCode="en" name="Finish"/>
						<nls languageCode="es" name="Finish"/>
						<nls languageCode="fi" name="Finish"/>
						<nls languageCode="fr" name="Finish"/>
						<nls languageCode="hu" name="Finish"/>
						<nls languageCode="it" name="Finish"/>
						<nls languageCode="ja" name="Finish"/>
						<nls languageCode="ko" name="Finish"/>
						<nls languageCode="nl" name="Finish"/>
						<nls languageCode="no" name="Finish"/>
						<nls languageCode="pl" name="Finish"/>
						<nls languageCode="pt" name="Fim"/>
						<nls languageCode="ru" name="Finish"/>
						<nls languageCode="sv" name="Finish"/>
						<nls languageCode="tr" name="Finish"/>
						<nls languageCode="zh" name="Finish"/>
						<nls languageCode="zh_TW" name="Finish"/>
						<Notifications notifyOwner="false">
							<NotifyWhen stepCompleted="false" stepInError="false" stepStarted="false"/>
							<Assignees/>
						</Notifications>
						<Operations>
							<Action code="cpc_logout" synchronized="true" type="BPM_SAT_CUSTOM">
								<nls languageCode="ca" name="Logging Out"/>
								<nls languageCode="cs" name="Logging Out"/>
								<nls languageCode="da" name="Logging Out"/>
								<nls languageCode="de" name="Logging Out"/>
								<nls description="Set tasks cpc_update field to 0 and log out of Clarity" languageCode="en" name="Logging Out"/>
								<nls languageCode="es" name="Logging Out"/>
								<nls languageCode="fi" name="Logging Out"/>
								<nls languageCode="fr" name="Logging Out"/>
								<nls languageCode="hu" name="Logging Out"/>
								<nls languageCode="it" name="Logging Out"/>
								<nls languageCode="ja" name="Logging Out"/>
								<nls languageCode="ko" name="Logging Out"/>
								<nls languageCode="nl" name="Logging Out"/>
								<nls languageCode="no" name="Logging Out"/>
								<nls languageCode="pl" name="Logging Out"/>
								<nls description="Atualiza o campo cpc_update das tarefas para 0 e faz logout do Clarity" languageCode="pt" name="Logging Out"/>
								<nls languageCode="ru" name="Logging Out"/>
								<nls languageCode="sv" name="Logging Out"/>
								<nls languageCode="tr" name="Logging Out"/>
								<nls languageCode="zh" name="Logging Out"/>
								<nls languageCode="zh_TW" name="Logging Out"/>
								<customScript languageCode="gel">
									<scriptText>
										<gel:script xmlns:core="jelly:core" xmlns:email="jelly:email" xmlns:file="jelly:com.niku.union.gel.FileTagLibrary"
                  xmlns:ftp="jelly:com.niku.union.gel.FTPTagLibrary" xmlns:gel="jelly:com.niku.union.gel.GELTagLibrary"
                  xmlns:soap="jelly:com.niku.union.gel.SOAPTagLibrary" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:sql="jelly:sql"
                  xmlns:xog="http://www.niku.com/xog" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
											<!-- Setting the database -->
											<core:catch var="connFail">
												<gel:setDataSource dbId="Niku" var="database"/>
											</core:catch>
											<!-- Checking if database is available -->
											<core:if test="${ connFail != null }">
												<gel:log level="error" message="Database not available!"/>
											</core:if>
											<!-- Debugging -->
											<core:if test="${ debug == 1 }">
												<gel:log level="debug" message="Session ID: ${sessionID}"/>
												<gel:log level="debug" message="Database Connection: ${database} | ${connFail}"/>
											</core:if>
											<!-- Capturing custom script output -->
											<core:catch var="customScript">
												<!-- Fetching active projects, no templates, which native calculation method is manual,  -->
												<!-- custom calculation method is duration and have updates on DETAIL task duration or % complete -->
												<sql:query dataSource="${database}" escapeText="false" var="projects">
												<![CDATA[
													SELECT DISTINCT 
																inv.id,
																inv.name,
																inv.code
													FROM        inv_projects prj
														JOIN    odf_ca_project odf_prj  ON prj.prid = odf_prj.id
														JOIN    inv_investments inv     ON prj.prid = inv.id
														JOIN    prtask tsk              ON prj.prid = tsk.prprojectid
														JOIN    odf_ca_task odf_tsk     ON tsk.prid = odf_tsk.id
													WHERE       prj.is_template = 0 
														AND     inv.odf_object_code = 'project' 
														AND     inv.is_active = 1
														AND     (prj.percent_calc_mode = 0 AND odf_prj.cpc_calc_method = 'DURATION')
														AND     odf_tsk.cpc_update = 1
														AND     tsk.pristask = 1
												]]>
												</sql:query>
												<core:forEach items="${projects.rows}" trim="true" var="row">
													<core:set value="${row.id}" var="prj_id"/>
													<core:set value="${row.name}" var="prj_name"/>
													<core:set value="${row.code}" var="prj_code"/>
													<core:if test="${ debug == 1 }">
														<gel:log level="debug" message="Working with Project: ${prj_name} | ID: ${prj_id} | Code: ${prj_code}"/>
													</core:if>
													<!-- Fetching tasks that have been updated (task duration or % complete) -->
													<sql:query dataSource="${database}" escapeText="false"
                          var="tasks">
													<![CDATA[
														SELECT  tsk.prid,
																tsk.prname,
																tsk.prwbslevel,
																tsk.prexternalid
														FROM    prtask tsk
														JOIN    odf_ca_task odf_tsk     ON tsk.prid = odf_tsk.id
														WHERE   tsk.prprojectid = ?
															AND tsk.pristask = 1
															AND odf_tsk.cpc_update = 1
														ORDER BY tsk.prwbssequence
													]]>
														<sql:param value="${prj_id}"/>
													</sql:query>
													<core:forEach items="${tasks.rows}" trim="true" var="row2">
														<core:set value="${row2.prid}" var="tsk_id"/>
														<core:set value="${row2.prname}" var="tsk_name"/>
														<core:set value="${row2.prwbslevel}" var="tsk_outline_level"/>
														<core:set value="${row2.prexternalid}" var="tsk_ext_id"/>
														<core:if test="${ debug == 1 }">
															<gel:log level="debug" message="Working with Task: ${tsk_name} | ID: ${tsk_id} | Level: ${tsk_outline_level} | External ID: ${tsk_ext_id}"/>
														</core:if>
														<!-- If the external ID is null, it's not possible to update the task through XOG, so I'm filling out this field before updating -->
														<!-- I'm doing a direct database update, because there's no way to update only the task external ID through XOG -->
														<core:if test="${ tsk_ext_id == null }">
															<sql:update dataSource="${database}"
                              escapeText="0">
																<![CDATA[
																	UPDATE prtask SET prexternalid=? where prid=?
																]]>
																<sql:param value="${tsk_id}"/>
																<sql:param value="${tsk_id}"/>
																<core:set value="${tsk_id}" var="tsk_ext_id"/>
																<core:if test="${ debug == 1 }">
																	<gel:log level="debug" message="Task External ID updated from null to ${tsk_id}"/>
																</core:if>
															</sql:update>
														</core:if>
														<!-- Creating xog write to update tasks -->
														<gel:parse var="updateTasks">
															<NikuDataBus xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../xsd/nikuxog_project.xsd">
																<Header action="write" externalSource="NIKU" objectType="project" version="15.6.1.265"/>
																<Projects>
																	<Project name="${prj_name}" projectID="${prj_code}">
																		<Tasks>
																			<Task internalTaskID="${tsk_id}" name="${tsk_name}" outlineLevel="${tsk_outline_level}" taskID="${tsk_ext_id}">
																				<CustomInformation>
																					<ColumnValue name="cpc_update">0</ColumnValue>
																				</CustomInformation>
																			</Task>
																		</Tasks>
																	</Project>
																</Projects>
															</NikuDataBus>
														</gel:parse>
														<!-- Executing xog write -->
														<soap:invoke endpoint="internal" var="result">
															<soap:message>
																<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xog="http://www.niku.com/xog">
																	<soapenv:Header>
																		<xog:Auth>
																			<xog:SessionID>${sessionID}</xog:SessionID>
																		</xog:Auth>
																	</soapenv:Header>
																	<soapenv:Body>
																		<gel:include select="$updateTasks"/>
																	</soapenv:Body>
																</soapenv:Envelope>
															</soap:message>
														</soap:invoke>
														<!-- Checking if xog returned any error -->
														<gel:set asString="true" select="$result//Statistics/@failureRecords" var="failureRecs"/>
														<core:if test="${failureRecs != '0'}">
															<gel:log level="error" message="A Problem with the XOG happened!"/>
															<gel:log level="error">Caught Exception was: <gel:expr select="$result"/>
															</gel:log>
														</core:if>
													</core:forEach>
												</core:forEach>
											</core:catch>
											<!-- Checking if custom script has returned any error -->
											<core:if test="${ customScript != null }">
												<gel:log level="error" message="Error: ${customScript}"/>
											</core:if>
											<!-- Logging out of Clarity -->
											<soap:invoke endpoint="internal" var="logout">
												<soap:message>
													<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xog="http://www.niku.com/xog">
														<soapenv:Header>
															<xog:Auth>
																<xog:SessionID>${sessionID}</xog:SessionID>
															</xog:Auth>
														</soapenv:Header>
														<soapenv:Body>
															<xog:Logout/>
														</soapenv:Body>
													</soapenv:Envelope>
												</soap:message>
											</soap:invoke>
										</gel:script>
									</scriptText>
								</customScript>
								<Notifications notifyOwner="false">
									<NotifyWhen stepActionInError="false" stepActionPerformed="false" value="0"/>
									<Assignees/>
								</Notifications>
							</Action>
						</Operations>
						<TransitionRestrictions>
							<TransitionRestriction>
								<Join type="BPM_JT_NONE">
									<Condition sequencNo="1" type="BPM_SCT_PRECONDITION"/>
								</Join>
							</TransitionRestriction>
							<TransitionRestriction>
								<Split type="BPM_ST_SEQUENCE">
									<Condition sequencNo="1" type="BPM_SCT_POSTCONDITION">
										<Transitions/>
									</Condition>
								</Split>
							</TransitionRestriction>
						</TransitionRestrictions>
					</Step>
					<Step id="cpc_update_tasks" isMileStone="false" sequenceNo="3">
						<nls languageCode="ca" name="Update Detail Tasks"/>
						<nls languageCode="cs" name="Update Detail Tasks"/>
						<nls languageCode="da" name="Update Detail Tasks"/>
						<nls languageCode="de" name="Update Detail Tasks"/>
						<nls description="Updates Days Complete for detail tasks" languageCode="en" name="Update Detail Tasks"/>
						<nls languageCode="es" name="Update Detail Tasks"/>
						<nls languageCode="fi" name="Update Detail Tasks"/>
						<nls languageCode="fr" name="Update Detail Tasks"/>
						<nls languageCode="hu" name="Update Detail Tasks"/>
						<nls languageCode="it" name="Update Detail Tasks"/>
						<nls languageCode="ja" name="Update Detail Tasks"/>
						<nls languageCode="ko" name="Update Detail Tasks"/>
						<nls languageCode="nl" name="Update Detail Tasks"/>
						<nls languageCode="no" name="Update Detail Tasks"/>
						<nls languageCode="pl" name="Update Detail Tasks"/>
						<nls description="Atualiza os Dias Concluídos das tarefas" languageCode="pt" name="Atualiza Tarefas"/>
						<nls languageCode="ru" name="Update Detail Tasks"/>
						<nls languageCode="sv" name="Update Detail Tasks"/>
						<nls languageCode="tr" name="Update Detail Tasks"/>
						<nls languageCode="zh" name="Update Detail Tasks"/>
						<nls languageCode="zh_TW" name="Update Detail Tasks"/>
						<Notifications notifyOwner="false">
							<NotifyWhen stepCompleted="false" stepInError="false" stepStarted="false"/>
							<Assignees/>
						</Notifications>
						<Operations>
							<Action code="cpc_calc_days_complete" synchronized="true" type="BPM_SAT_CUSTOM">
								<nls languageCode="ca" name="Calculate Days Complete"/>
								<nls languageCode="cs" name="Calculate Days Complete"/>
								<nls languageCode="da" name="Calculate Days Complete"/>
								<nls languageCode="de" name="Calculate Days Complete"/>
								<nls description="Calculates Days Complete for detail tasks. Days Complete = Task Duration * % Complete" languageCode="en" name="Calculate Days Complete"/>
								<nls languageCode="es" name="Calculate Days Complete"/>
								<nls languageCode="fi" name="Calculate Days Complete"/>
								<nls languageCode="fr" name="Calculate Days Complete"/>
								<nls languageCode="hu" name="Calculate Days Complete"/>
								<nls languageCode="it" name="Calculate Days Complete"/>
								<nls languageCode="ja" name="Calculate Days Complete"/>
								<nls languageCode="ko" name="Calculate Days Complete"/>
								<nls languageCode="nl" name="Calculate Days Complete"/>
								<nls languageCode="no" name="Calculate Days Complete"/>
								<nls languageCode="pl" name="Calculate Days Complete"/>
								<nls description="Calcula os Dias Concluídos das tarefas. Dias Concluídos = Duração * % Concluído" languageCode="pt" name="Calcular Dias Concluídos"/>
								<nls languageCode="ru" name="Calculate Days Complete"/>
								<nls languageCode="sv" name="Calculate Days Complete"/>
								<nls languageCode="tr" name="Calculate Days Complete"/>
								<nls languageCode="zh" name="Calculate Days Complete"/>
								<nls languageCode="zh_TW" name="Calculate Days Complete"/>
								<customScript languageCode="gel">
									<scriptText>
										<gel:script xmlns:core="jelly:core" xmlns:email="jelly:email" xmlns:file="jelly:com.niku.union.gel.FileTagLibrary"
                  xmlns:ftp="jelly:com.niku.union.gel.FTPTagLibrary" xmlns:gel="jelly:com.niku.union.gel.GELTagLibrary"
                  xmlns:soap="jelly:com.niku.union.gel.SOAPTagLibrary" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:sql="jelly:sql"
                  xmlns:xog="http://www.niku.com/xog" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
											<!-- Setting the database -->
											<core:catch var="connFail">
												<gel:setDataSource dbId="Niku" var="database"/>
											</core:catch>
											<!-- Checking if database is available -->
											<core:if test="${ connFail != null }">
												<gel:log level="error" message="Database not available!"/>
											</core:if>
											<!-- Debugging -->
											<core:if test="${ debug == 1 }">
												<gel:log level="debug" message="Session ID: ${sessionID}"/>
												<gel:log level="debug" message="Database Connection: ${database} | ${connFail}"/>
											</core:if>
											<!-- Capturing custom script output -->
											<core:catch var="customScript">
												<!-- Fetching active projects, no templates, which native calculation method is manual,  -->
												<!-- custom calculation method is duration and have updates on DETAIL task duration or % complete -->
												<sql:query dataSource="${database}" escapeText="false" var="projects">
												<![CDATA[
													SELECT DISTINCT 
																inv.id,
																inv.name,
																inv.code
													FROM        inv_projects prj
														JOIN    odf_ca_project odf_prj  ON prj.prid = odf_prj.id
														JOIN    inv_investments inv     ON prj.prid = inv.id
														JOIN    prtask tsk              ON prj.prid = tsk.prprojectid
														JOIN    odf_ca_task odf_tsk     ON tsk.prid = odf_tsk.id
													WHERE       prj.is_template = 0 
														AND     inv.odf_object_code = 'project' 
														AND     inv.is_active = 1
														AND     (prj.percent_calc_mode = 0 AND odf_prj.cpc_calc_method = 'DURATION')
														AND     odf_tsk.cpc_update = 1
														AND     tsk.pristask = 1
												]]>
												</sql:query>
												<core:forEach items="${projects.rows}" trim="true" var="row">
													<core:set value="${row.id}" var="prj_id"/>
													<core:set value="${row.name}" var="prj_name"/>
													<core:set value="${row.code}" var="prj_code"/>
													<core:if test="${ debug == 1 }">
														<gel:log level="debug" message="Working with Project: ${prj_name} | ID: ${prj_id} | Code: ${prj_code}"/>
													</core:if>
													<!-- Fetching tasks that have been updated (task duration or % complete) -->
													<sql:query dataSource="${database}" escapeText="false"
                          var="tasks">
													<![CDATA[
														SELECT  tsk.prid,
																tsk.prname,
																tsk.prwbslevel,
																tsk.prexternalid,
																tsk.prduration,
																ROUND(tsk.prduration * tsk.prpctcomplete, 2) days_complete
														FROM    prtask tsk
														JOIN    odf_ca_task odf_tsk     ON tsk.prid = odf_tsk.id
														WHERE   tsk.prprojectid = ?
															AND tsk.pristask = 1
															AND odf_tsk.cpc_update = 1
														ORDER BY tsk.prwbssequence
													]]>
														<sql:param value="${prj_id}"/>
													</sql:query>
													<core:forEach items="${tasks.rows}" trim="true" var="row2">
														<core:set value="${row2.prid}" var="tsk_id"/>
														<core:set value="${row2.prname}" var="tsk_name"/>
														<core:set value="${row2.prwbslevel}" var="tsk_outline_level"/>
														<core:set value="${row2.prexternalid}" var="tsk_ext_id"/>
														<core:set value="${row2.prduration}" var="tsk_duration"/>
														<core:set value="${row2.days_complete}" var="tsk_days_complete"/>
														<core:if test="${ debug == 1 }">
															<gel:log level="debug" message="Working with Task: ${tsk_name} | ID: ${tsk_id} | Level: ${tsk_outline_level} | External ID: ${tsk_ext_id} | Duration: ${tsk_duration} | Days Complete: ${tsk_days_complete}"/>
														</core:if>
														<!-- If the external ID is null, it's not possible to update the task through XOG, so I'm filling out this field before updating -->
														<!-- I'm doing a direct database update, because there's no way to update only the task external ID through XOG -->
														<core:if test="${ tsk_ext_id == null }">
															<sql:update dataSource="${database}"
                              escapeText="0">
																<![CDATA[
																	UPDATE prtask SET prexternalid=? where prid=?
																]]>
																<sql:param value="${tsk_id}"/>
																<sql:param value="${tsk_id}"/>
																<core:set value="${tsk_id}" var="tsk_ext_id"/>
															</sql:update>
														</core:if>
														<!-- Creating xog write to update tasks -->
														<gel:parse var="updateTasks">
															<NikuDataBus xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../xsd/nikuxog_project.xsd">
																<Header action="write" externalSource="NIKU" objectType="project" version="15.6.1.265"/>
																<Projects>
																	<Project name="${prj_name}" projectID="${prj_code}">
																		<Tasks>
																			<Task internalTaskID="${tsk_id}" name="${tsk_name}" outlineLevel="${tsk_outline_level}" taskID="${tsk_ext_id}">
																				<CustomInformation>
																					<ColumnValue name="cpc_days_complete">${tsk_days_complete}</ColumnValue>
																					<ColumnValue name="cpc_duration">${tsk_duration}</ColumnValue>
																				</CustomInformation>
																			</Task>
																		</Tasks>
																	</Project>
																</Projects>
															</NikuDataBus>
														</gel:parse>
														<!-- Executing xog write -->
														<soap:invoke endpoint="internal" var="result">
															<soap:message>
																<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xog="http://www.niku.com/xog">
																	<soapenv:Header>
																		<xog:Auth>
																			<xog:SessionID>${sessionID}</xog:SessionID>
																		</xog:Auth>
																	</soapenv:Header>
																	<soapenv:Body>
																		<gel:include select="$updateTasks"/>
																	</soapenv:Body>
																</soapenv:Envelope>
															</soap:message>
														</soap:invoke>
														<!-- Checking if xog returned any error -->
														<gel:set asString="true" select="$result//Statistics/@failureRecords" var="failureRecs"/>
														<core:if test="${failureRecs != '0'}">
															<gel:log level="error" message="A Problem with the XOG happened!"/>
															<gel:log level="error">Caught Exception was: <gel:expr select="$result"/>
															</gel:log>
														</core:if>
													</core:forEach>
												</core:forEach>
											</core:catch>
											<!-- Checking if custom script has returned any error -->
											<core:if test="${ customScript != null }">
												<gel:log level="error" message="Error: ${customScript}"/>
											</core:if>
										</gel:script>
									</scriptText>
								</customScript>
								<Notifications notifyOwner="false">
									<NotifyWhen stepActionInError="false" stepActionPerformed="false" value="0"/>
									<Assignees/>
								</Notifications>
							</Action>
						</Operations>
						<TransitionRestrictions>
							<TransitionRestriction>
								<Join type="BPM_JT_NONE">
									<Condition sequencNo="1" type="BPM_SCT_PRECONDITION"/>
								</Join>
							</TransitionRestriction>
							<TransitionRestriction>
								<Split type="BPM_ST_SEQUENCE">
									<Condition sequencNo="1" type="BPM_SCT_POSTCONDITION">
										<Transitions>
											<Transition to="cpc_update_summary_tasks"/>
										</Transitions>
									</Condition>
								</Split>
							</TransitionRestriction>
						</TransitionRestrictions>
					</Step>
					<Step id="cpc_update_summary_tasks" isMileStone="false" sequenceNo="4">
						<nls languageCode="ca" name="Update Summary Tasks"/>
						<nls languageCode="cs" name="Update Summary Tasks"/>
						<nls languageCode="da" name="Update Summary Tasks"/>
						<nls languageCode="de" name="Update Summary Tasks"/>
						<nls description="Updates % Complete for summary tasks." languageCode="en" name="Update Summary Tasks"/>
						<nls languageCode="es" name="Update Summary Tasks"/>
						<nls languageCode="fi" name="Update Summary Tasks"/>
						<nls languageCode="fr" name="Update Summary Tasks"/>
						<nls languageCode="hu" name="Update Summary Tasks"/>
						<nls languageCode="it" name="Update Summary Tasks"/>
						<nls languageCode="ja" name="Update Summary Tasks"/>
						<nls languageCode="ko" name="Update Summary Tasks"/>
						<nls languageCode="nl" name="Update Summary Tasks"/>
						<nls languageCode="no" name="Update Summary Tasks"/>
						<nls languageCode="pl" name="Update Summary Tasks"/>
						<nls description="Atualiza o % Concluído das tarefas agregadoras." languageCode="pt" name="Atualiza Tarefas Agregadoras"/>
						<nls languageCode="ru" name="Update Summary Tasks"/>
						<nls languageCode="sv" name="Update Summary Tasks"/>
						<nls languageCode="tr" name="Update Summary Tasks"/>
						<nls languageCode="zh" name="Update Summary Tasks"/>
						<nls languageCode="zh_TW" name="Update Summary Tasks"/>
						<Notifications notifyOwner="false">
							<NotifyWhen stepCompleted="false" stepInError="false" stepStarted="false"/>
							<Assignees/>
						</Notifications>
						<Operations>
							<Action code="cpc_update_summary" synchronized="true" type="BPM_SAT_CUSTOM">
								<nls languageCode="ca" name="Update Summary Tasks % Complete"/>
								<nls languageCode="cs" name="Update Summary Tasks % Complete"/>
								<nls languageCode="da" name="Update Summary Tasks % Complete"/>
								<nls languageCode="de" name="Update Summary Tasks % Complete"/>
								<nls description="Calculates % Complete for summary tasks. % Complete = Total Childs Days Complete / Total Childs Duration"
              languageCode="en" name="Calculate Summary Tasks % Complete"/>
								<nls languageCode="es" name="Update Summary Tasks % Complete"/>
								<nls languageCode="fi" name="Update Summary Tasks % Complete"/>
								<nls languageCode="fr" name="Update Summary Tasks % Complete"/>
								<nls languageCode="hu" name="Update Summary Tasks % Complete"/>
								<nls languageCode="it" name="Update Summary Tasks % Complete"/>
								<nls languageCode="ja" name="Update Summary Tasks % Complete"/>
								<nls languageCode="ko" name="Update Summary Tasks % Complete"/>
								<nls languageCode="nl" name="Update Summary Tasks % Complete"/>
								<nls languageCode="no" name="Update Summary Tasks % Complete"/>
								<nls languageCode="pl" name="Update Summary Tasks % Complete"/>
								<nls
              description="Calcula o % Concluído das tarefas agregadoras. % Concluído = Total dos Dias Concluídos das tarefas filhas / Total de duração das tarefas filhas"
              languageCode="pt" name="Calcula o % Concluído das Tarefas Agregadoras"/>
								<nls languageCode="ru" name="Update Summary Tasks % Complete"/>
								<nls languageCode="sv" name="Update Summary Tasks % Complete"/>
								<nls languageCode="tr" name="Update Summary Tasks % Complete"/>
								<nls languageCode="zh" name="Update Summary Tasks % Complete"/>
								<nls languageCode="zh_TW" name="Update Summary Tasks % Complete"/>
								<customScript languageCode="gel">
									<scriptText>
										<gel:script xmlns:core="jelly:core" xmlns:email="jelly:email" xmlns:file="jelly:com.niku.union.gel.FileTagLibrary"
                  xmlns:ftp="jelly:com.niku.union.gel.FTPTagLibrary" xmlns:gel="jelly:com.niku.union.gel.GELTagLibrary"
                  xmlns:soap="jelly:com.niku.union.gel.SOAPTagLibrary" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:sql="jelly:sql"
                  xmlns:xog="http://www.niku.com/xog" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
											<!-- Setting the database -->
											<core:catch var="connFail">
												<gel:setDataSource dbId="Niku" var="database"/>
											</core:catch>
											<!-- Checking if database is available -->
											<core:if test="${ connFail != null }">
												<gel:log level="error" message="Database not available!"/>
											</core:if>
											<!-- Debugging -->
											<core:if test="${ debug == 1 }">
												<gel:log level="debug" message="Session ID: ${sessionID}"/>
												<gel:log level="debug" message="Database Connection: ${database} | ${connFail}"/>
											</core:if>
											<!-- Capturing custom script output -->
											<core:catch var="customScript">
												<!-- Fetching active projects, no templates, which native calculation method is manual,  -->
												<!-- custom calculation method is duration and have updates on DETAIL task duration or % complete -->
												<!-- If there's no change on detail tasks, there's no need to update summary tasks -->
												<sql:query dataSource="${database}" escapeText="false" var="projects">
												<![CDATA[
													SELECT DISTINCT 
																inv.id,
																inv.name,
																inv.code
													FROM        inv_projects prj
														JOIN    odf_ca_project odf_prj  ON prj.prid = odf_prj.id
														JOIN    inv_investments inv     ON prj.prid = inv.id
														JOIN    prtask tsk              ON prj.prid = tsk.prprojectid
														JOIN    odf_ca_task odf_tsk     ON tsk.prid = odf_tsk.id
													WHERE       prj.is_template = 0 
														AND     inv.odf_object_code = 'project' 
														AND     inv.is_active = 1
														AND     (prj.percent_calc_mode = 0 AND odf_prj.cpc_calc_method = 'DURATION')
														AND     odf_tsk.cpc_update = 1
														AND     tsk.pristask = 1
												]]>
												</sql:query>
												<core:forEach items="${projects.rows}" trim="true" var="row">
													<core:set value="${row.id}" var="prj_id"/>
													<core:set value="${row.name}" var="prj_name"/>
													<core:set value="${row.code}" var="prj_code"/>
													<core:set value="0" var="wbs_level"/>
													<sql:query dataSource="${database}" escapeText="false"
                          var="wbs">
													<![CDATA[
														SELECT MAX(prwbslevel) wbs_levels
														FROM 	prtask
														WHERE 	prprojectid = ?
														AND 	pristask = 0
													]]>
														<sql:param value="${prj_id}"/>
													</sql:query>
													<core:set value="${wbs.rows[0].wbs_levels}" var="wbs_level"/>
													<core:if test="${ debug == 1 }">
														<gel:log level="debug" message="Working with Project: ${prj_name} | ID: ${prj_id} | Code: ${prj_code}"/>
														<gel:log level="debug" message="This Gantt has ${wbs_level} levels of summary tasks"/>
													</core:if>
													<core:while test="${wbs_level > 0}">
														<!-- Fetching only summary tasks that need to be updated -->
														<sql:query dataSource="${database}" escapeText="false"
                            var="tasks">
														<![CDATA[
															SELECT  gantt.parent_id,
																	gantt.parent_task,
																	gantt.prwbslevel,
																	gantt.prexternalid,
																	SUM(gantt.cpc_duration) prduration,
																	SUM(gantt.days_complete) days_complete,
																	CASE SUM(gantt.cpc_duration) WHEN 0 THEN 0 ELSE ROUND(SUM(gantt.days_complete) / SUM(gantt.cpc_duration), 2) END pct_complete
															FROM (
																SELECT  tsk.prprojectid,
																		parent_task.prid parent_id,
																		parent_task.prname parent_task,
																		parent_task.prwbslevel,
																		parent_task.prexternalid,
																		odf_tsk.cpc_duration,
																		cpc_days_complete days_complete
																FROM        prtask tsk
																LEFT JOIN   ( SELECT prid, prname, prprojectid, prwbssequence, pristask, prwbslevel, prexternalid
																			  FROM prtask ) parent_task    ON   parent_task.prwbssequence = tsk.wbs_parseq
																										   AND  parent_task.prprojectid = tsk.prprojectid
																										   AND  parent_task.pristask = 0
																JOIN    odf_ca_task odf_tsk                ON   tsk.prid = odf_tsk.id
																WHERE 	odf_tsk.cpc_exclude = 0 
																		AND tsk.prismilestone = 0
																CONNECT BY PRIOR tsk.prid = parent_task.prid
																START WITH parent_task.prid IS NULL
																ORDER BY tsk. prwbssequence
															) gantt
															WHERE gantt.prprojectid = ?
																  AND gantt.parent_id IS NOT NULL
																  AND gantt.prwbslevel = ?
															GROUP BY gantt.parent_id, gantt.parent_task, gantt.prwbslevel, gantt.prexternalid
														]]>
															<sql:param value="${prj_id}"/>
															<sql:param value="${wbs_level}"/>
														</sql:query>
														<core:forEach items="${tasks.rows}" trim="true" var="row2">
															<core:set value="${row2.parent_id}" var="tsk_id"/>
															<core:set value="${row2.parent_task}" var="tsk_name"/>
															<core:set value="${row2.prwbslevel}" var="tsk_outline_level"/>
															<core:set value="${row2.prexternalid}" var="tsk_ext_id"/>
															<core:set value="${row2.days_complete}" var="tsk_days_complete"/>
															<core:set value="${row2.prduration}" var="tsk_duration"/>
															<core:set value="${row2.pct_complete}" var="tsk_pctcomplete"/>
															<core:if test="${ debug == 1 }">
																<gel:log level="debug" message="Working with Summary Task: ${tsk_name} | ID: ${tsk_id} | Level: ${tsk_outline_level} | External ID: ${tsk_ext_id} | Duration: ${tsk_duration} | Days Complete: ${tsk_days_complete} | Pct Complete: ${tsk_pctcomplete}"/>
															</core:if>
															<!-- If the external ID is null, it's not possible to update the task through XOG, so I'm filling out this field before updating -->
															<!-- I'm doing a direct database update, because there's no way to update only the task external ID through XOG -->
															<core:if test="${ tsk_ext_id == null }">
																<sql:update dataSource="${database}"
                                escapeText="0">
																	<![CDATA[
																		UPDATE prtask SET prexternalid=? where prid=?
																	]]>
																	<sql:param value="${tsk_id}"/>
																	<sql:param value="${tsk_id}"/>
																	<core:set value="${tsk_id}" var="tsk_ext_id"/>
																	<core:if test="${ debug == 1 }">
																		<gel:log level="debug" message="Task External ID updated from null to ${tsk_id}"/>
																	</core:if>
																</sql:update>
															</core:if>
															<!-- Creating xog write to update tasks -->
															<gel:parse var="updateTasks">
																<NikuDataBus xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../xsd/nikuxog_project.xsd">
																	<Header action="write" externalSource="NIKU" objectType="project" version="15.6.1.265"/>
																	<Projects>
																		<Project name="${prj_name}" projectID="${prj_code}">
																			<Tasks>
																				<Task internalTaskID="${tsk_id}" name="${tsk_name}" outlineLevel="${tsk_outline_level}"
                                      percComp="${tsk_pctcomplete}" taskID="${tsk_ext_id}">
																					<CustomInformation>
																						<ColumnValue name="cpc_days_complete">${tsk_days_complete}</ColumnValue>
																						<ColumnValue name="cpc_duration">${tsk_duration}</ColumnValue>
																					</CustomInformation>
																				</Task>
																			</Tasks>
																		</Project>
																	</Projects>
																</NikuDataBus>
															</gel:parse>
															<!-- Executing xog write -->
															<soap:invoke endpoint="internal" var="result">
																<soap:message>
																	<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xog="http://www.niku.com/xog">
																		<soapenv:Header>
																			<xog:Auth>
																				<xog:SessionID>${sessionID}</xog:SessionID>
																			</xog:Auth>
																		</soapenv:Header>
																		<soapenv:Body>
																			<gel:include select="$updateTasks"/>
																		</soapenv:Body>
																	</soapenv:Envelope>
																</soap:message>
															</soap:invoke>
															<!-- Checking if xog returned any error -->
															<gel:set asString="true" select="$result//Statistics/@failureRecords" var="failureRecs"/>
															<core:if test="${failureRecs != '0'}">
																<gel:log level="error" message="A Problem with the XOG happened!"/>
																<gel:log level="error">Caught Exception was: <gel:expr select="$result"/>
																</gel:log>
															</core:if>
														</core:forEach>
														<core:set value="${wbs_level - 1}" var="wbs_level"/>
													</core:while>
												</core:forEach>
											</core:catch>
											<!-- Checking if custom script has returned any error -->
											<core:if test="${ customScript != null }">
												<gel:log level="error" message="Error: ${customScript}"/>
											</core:if>
										</gel:script>
									</scriptText>
								</customScript>
								<Notifications notifyOwner="false">
									<NotifyWhen stepActionInError="false" stepActionPerformed="false" value="0"/>
									<Assignees/>
								</Notifications>
							</Action>
						</Operations>
						<TransitionRestrictions>
							<TransitionRestriction>
								<Join type="BPM_JT_NONE">
									<Condition sequencNo="1" type="BPM_SCT_PRECONDITION"/>
								</Join>
							</TransitionRestriction>
							<TransitionRestriction>
								<Split type="BPM_ST_SEQUENCE">
									<Condition sequencNo="1" type="BPM_SCT_POSTCONDITION">
										<Transitions>
											<Transition to="cpc_update_projects"/>
										</Transitions>
									</Condition>
								</Split>
							</TransitionRestriction>
						</TransitionRestrictions>
					</Step>
					<Step id="cpc_update_projects" isMileStone="false" sequenceNo="5">
						<nls languageCode="ca" name="Update Projects"/>
						<nls languageCode="cs" name="Update Projects"/>
						<nls languageCode="da" name="Update Projects"/>
						<nls languageCode="de" name="Update Projects"/>
						<nls description="Updates % Complete for projects" languageCode="en" name="Update Projects"/>
						<nls languageCode="es" name="Update Projects"/>
						<nls languageCode="fi" name="Update Projects"/>
						<nls languageCode="fr" name="Update Projects"/>
						<nls languageCode="hu" name="Update Projects"/>
						<nls languageCode="it" name="Update Projects"/>
						<nls languageCode="ja" name="Update Projects"/>
						<nls languageCode="ko" name="Update Projects"/>
						<nls languageCode="nl" name="Update Projects"/>
						<nls languageCode="no" name="Update Projects"/>
						<nls languageCode="pl" name="Update Projects"/>
						<nls description="Atualiza o % Concluído dos projetos" languageCode="pt" name="Atualiza Projetos"/>
						<nls languageCode="ru" name="Update Projects"/>
						<nls languageCode="sv" name="Update Projects"/>
						<nls languageCode="tr" name="Update Projects"/>
						<nls languageCode="zh" name="Update Projects"/>
						<nls languageCode="zh_TW" name="Update Projects"/>
						<Notifications notifyOwner="false">
							<NotifyWhen stepCompleted="false" stepInError="false" stepStarted="false"/>
							<Assignees/>
						</Notifications>
						<Operations>
							<Action code="cpc_update_prj" synchronized="true" type="BPM_SAT_CUSTOM">
								<nls languageCode="ca" name="Update Project % Complete"/>
								<nls languageCode="cs" name="Update Project % Complete"/>
								<nls languageCode="da" name="Update Project % Complete"/>
								<nls languageCode="de" name="Update Project % Complete"/>
								<nls description="Calculates % Complete for projects. % Complete = Total Level 1 Tasks Days Complete / Total Level 1 Tasks Duration"
              languageCode="en" name="Calculate Project % Complete"/>
								<nls languageCode="es" name="Update Project % Complete"/>
								<nls languageCode="fi" name="Update Project % Complete"/>
								<nls languageCode="fr" name="Update Project % Complete"/>
								<nls languageCode="hu" name="Update Project % Complete"/>
								<nls languageCode="it" name="Update Project % Complete"/>
								<nls languageCode="ja" name="Update Project % Complete"/>
								<nls languageCode="ko" name="Update Project % Complete"/>
								<nls languageCode="nl" name="Update Project % Complete"/>
								<nls languageCode="no" name="Update Project % Complete"/>
								<nls languageCode="pl" name="Update Project % Complete"/>
								<nls
              description="Calcula o % Concluído dos projetos. % Concluído = Total de Dias Concluídos das Tarefas de Nível 1 / Total de Duração das Tarefas de Nível 1"
              languageCode="pt" name="Calcula % Concluído do Projeto"/>
								<nls languageCode="ru" name="Update Project % Complete"/>
								<nls languageCode="sv" name="Update Project % Complete"/>
								<nls languageCode="tr" name="Update Project % Complete"/>
								<nls languageCode="zh" name="Update Project % Complete"/>
								<nls languageCode="zh_TW" name="Update Project % Complete"/>
								<customScript languageCode="gel">
									<scriptText>
										<gel:script xmlns:core="jelly:core" xmlns:email="jelly:email" xmlns:file="jelly:com.niku.union.gel.FileTagLibrary"
                  xmlns:ftp="jelly:com.niku.union.gel.FTPTagLibrary" xmlns:gel="jelly:com.niku.union.gel.GELTagLibrary"
                  xmlns:soap="jelly:com.niku.union.gel.SOAPTagLibrary" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:sql="jelly:sql"
                  xmlns:xog="http://www.niku.com/xog" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
											<!-- Setting the database -->
											<core:catch var="connFail">
												<gel:setDataSource dbId="Niku" var="database"/>
											</core:catch>
											<!-- Checking if database is available -->
											<core:if test="${ connFail != null }">
												<gel:log level="error" message="Database not available!"/>
											</core:if>
											<!-- Debugging -->
											<core:if test="${ debug == 1 }">
												<gel:log level="debug" message="Session ID: ${sessionID}"/>
												<gel:log level="debug" message="Database Connection: ${database} | ${connFail}"/>
											</core:if>
											<!-- Capturing custom script output -->
											<core:catch var="customScript">
												<!-- Fetching active projects, no templates, which native calculation method is manual,  -->
												<!-- custom calculation method is duration and have updates on DETAIL task duration or % complete -->
												<!-- If there's no change on detail tasks, there's no need to update the project % complete -->
												<sql:query dataSource="${database}" escapeText="false" var="projects">
												<![CDATA[
													SELECT DISTINCT 
																inv.id,
																inv.name,
																inv.code
													FROM        inv_projects prj
														JOIN    odf_ca_project odf_prj  ON prj.prid = odf_prj.id
														JOIN    inv_investments inv     ON prj.prid = inv.id
														JOIN    prtask tsk              ON prj.prid = tsk.prprojectid
														JOIN    odf_ca_task odf_tsk     ON tsk.prid = odf_tsk.id
													WHERE       prj.is_template = 0 
														AND     inv.odf_object_code = 'project' 
														AND     inv.is_active = 1
														AND     (prj.percent_calc_mode = 0 AND odf_prj.cpc_calc_method = 'DURATION')
														AND     odf_tsk.cpc_update = 1
														AND     tsk.pristask = 1
												]]>
												</sql:query>
												<core:forEach items="${projects.rows}" trim="true" var="row">
													<core:set value="${row.id}" var="prj_id"/>
													<core:set value="${row.name}" var="prj_name"/>
													<core:set value="${row.code}" var="prj_code"/>
													<sql:query dataSource="${database}" escapeText="false"
                          var="prj_cpc">
														<![CDATA[
															SELECT  CASE SUM(tsk.prduration) WHEN 0 THEN 0 ELSE ROUND(SUM(odf_tsk.cpc_days_complete) / SUM(odf_tsk.cpc_duration), 2) END pct_complete
															FROM    prtask tsk
															JOIN    odf_ca_task odf_tsk ON tsk.prid = odf_tsk.id
															WHERE   tsk.prwbslevel = 1
																AND odf_tsk.cpc_exclude = 0
																AND tsk.prprojectid = ?
																AND tsk.prismilestone = 0
														]]>
														<sql:param value="${prj_id}"/>
													</sql:query>
													<core:set value="${prj_cpc.rows[0].pct_complete}" var="prj_pctcomplete"/>
													<core:if test="${ debug == 1 }">
														<gel:log level="debug" message="Working with Project: ${prj_name} | ID: ${prj_id} | Code: ${prj_code} | Pct Complete: ${prj_pctcomplete}"/>
													</core:if>
													<!-- Creating xog write to update the Project % Complete -->
													<gel:parse var="updateProject">
														<NikuDataBus xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../xsd/nikuxog_project.xsd">
															<Header action="write" externalSource="NIKU" objectType="project" version="15.6.1.265"/>
															<Projects>
																<Project name="${prj_name}" percentComplete="${prj_pctcomplete}" projectID="${prj_code}"/>
															</Projects>
														</NikuDataBus>
													</gel:parse>
													<!-- Executing xog write -->
													<soap:invoke endpoint="internal" var="result">
														<soap:message>
															<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xog="http://www.niku.com/xog">
																<soapenv:Header>
																	<xog:Auth>
																		<xog:SessionID>${sessionID}</xog:SessionID>
																	</xog:Auth>
																</soapenv:Header>
																<soapenv:Body>
																	<gel:include select="$updateProject"/>
																</soapenv:Body>
															</soapenv:Envelope>
														</soap:message>
													</soap:invoke>
													<!-- Checking if xog returned any error -->
													<gel:set asString="true" select="$result//Statistics/@failureRecords" var="failureRecs"/>
													<core:if test="${failureRecs != '0'}">
														<gel:log level="error" message="A Problem with the XOG happened!"/>
														<gel:log level="error">Caught Exception was: <gel:expr select="$result"/>
														</gel:log>
													</core:if>
												</core:forEach>
											</core:catch>
											<!-- Checking if custom script has returned any error -->
											<core:if test="${ customScript != null }">
												<gel:log level="error" message="Error: ${customScript}"/>
											</core:if>
										</gel:script>
									</scriptText>
								</customScript>
								<Notifications notifyOwner="false">
									<NotifyWhen stepActionInError="false" stepActionPerformed="false" value="0"/>
									<Assignees/>
								</Notifications>
							</Action>
						</Operations>
						<TransitionRestrictions>
							<TransitionRestriction>
								<Join type="BPM_JT_NONE">
									<Condition sequencNo="1" type="BPM_SCT_PRECONDITION"/>
								</Join>
							</TransitionRestriction>
							<TransitionRestriction>
								<Split type="BPM_ST_SEQUENCE">
									<Condition sequencNo="1" type="BPM_SCT_POSTCONDITION">
										<Transitions>
											<Transition to="Finish"/>
										</Transitions>
									</Condition>
								</Split>
							</TransitionRestriction>
						</TransitionRestrictions>
					</Step>
				</Steps>
				<Groups/>
				<OBSAssocs complete="false"/>
			</Process>
		</Processes>
		<lookups update="true">
			<staticLookup autoSuggestEnabled="true" autoSuggestMaxSuggestions="10" code="CAL_EVENT_PRIORITY" hiddenAttributeName="id" sortStyle="manual"
    source="niku.com" status="active" update="true">
				<nls description="Prioritat dels esdeveniments del calendari" languageCode="ca" name="Prioritat del calendari"/>
				<nls description="Priorita události kalendáře" languageCode="cs" name="Priorita kalendáře"/>
				<nls description="Prioritet for kalenderaftale" languageCode="da" name="Kalenderprioritet"/>
				<nls description="Kalenderereignis - Priorität" languageCode="de" name="Kalenderpriorität"/>
				<nls description="Calendar Event Priority" languageCode="en" name="Calendar Priority"/>
				<nls description="Prioridad de los eventos del calendario" languageCode="es" name="Prioridad del calendario"/>
				<nls description="Kalenteritapahtuman prioriteetti" languageCode="fi" name="Kalenteriprioriteetti"/>
				<nls description="Priorité des événements du calendrier" languageCode="fr" name="Priorité sur le calendrier"/>
				<nls description="Naptáresemény prioritása" languageCode="hu" name="Naptár prioritása"/>
				<nls description="Priorità eventi calendario" languageCode="it" name="Priorità calendario"/>
				<nls description="カレンダ イベントの優先度" languageCode="ja" name="カレンダの優先度"/>
				<nls description="일정 이벤트 우선 순위" languageCode="ko" name="일정 우선 순위"/>
				<nls description="Prioriteit agenda-evenement" languageCode="nl" name="Agenda prioriteit"/>
				<nls description="Kalenderbegivenhetsprioritet" languageCode="no" name="Kalenderprioritet"/>
				<nls description="Priorytet zdarzenia w kalendarzu" languageCode="pl" name="Priorytet kalendarza"/>
				<nls description="Prioridade do evento do calendário" languageCode="pt" name="Prioridade do calendário"/>
				<nls description="Приоритет события календаря" languageCode="ru" name="Приоритет календаря"/>
				<nls description="Prioritet för kalenderhändelse" languageCode="sv" name="Kalenderprioritet"/>
				<nls description="Takvim Olayı Önceliği" languageCode="tr" name="Takvim Önceliği"/>
				<nls description="日历事件优先级" languageCode="zh" name="日历优先级"/>
				<nls description="行事曆事件優先順序" languageCode="zh_TW" name="行事曆優先順序"/>
				<lookupValue code="CAL_LOW" sortOrder="1" status="active">
					<nls description="Sota" languageCode="ca" name="Sota"/>
					<nls description="Nízké" languageCode="cs" name="Nízké"/>
					<nls description="Lav" languageCode="da" name="Lav"/>
					<nls description="Niedrig" languageCode="de" name="Niedrig"/>
					<nls description="Low" languageCode="en" name="Low"/>
					<nls description="Bajo" languageCode="es" name="Bajo"/>
					<nls description="Matala" languageCode="fi" name="Matala"/>
					<nls description="Faible" languageCode="fr" name="Faible"/>
					<nls description="Alacsony" languageCode="hu" name="Alacsony"/>
					<nls description="Bassa" languageCode="it" name="Bassa"/>
					<nls description="低" languageCode="ja" name="低"/>
					<nls description="낮음" languageCode="ko" name="낮음"/>
					<nls description="Laag" languageCode="nl" name="Laag"/>
					<nls description="Lav" languageCode="no" name="Lav"/>
					<nls description="Niski" languageCode="pl" name="Niski"/>
					<nls description="Baixo" languageCode="pt" name="Baixo"/>
					<nls description="Низкий" languageCode="ru" name="Низкий"/>
					<nls description="Låg" languageCode="sv" name="Låg"/>
					<nls description="Düşük" languageCode="tr" name="Düşük"/>
					<nls description="低" languageCode="zh" name="低"/>
					<nls description="低" languageCode="zh_TW" name="低"/>
				</lookupValue>
				<lookupValue code="CAL_MEDIUM" sortOrder="2" status="active">
					<nls description="Medi" languageCode="ca" name="Medi"/>
					<nls description="Střední" languageCode="cs" name="Střední"/>
					<nls description="Mellem" languageCode="da" name="Mellem"/>
					<nls description="Mittel" languageCode="de" name="Mittel"/>
					<nls description="Medium" languageCode="en" name="Medium"/>
					<nls description="Medio" languageCode="es" name="Medio"/>
					<nls description="Keskisuuri" languageCode="fi" name="Keskisuuri"/>
					<nls description="Moyen(ne)" languageCode="fr" name="Moyen(ne)"/>
					<nls description="Közepes" languageCode="hu" name="Közepes"/>
					<nls description="Media" languageCode="it" name="Media"/>
					<nls description="中" languageCode="ja" name="中"/>
					<nls description="중간" languageCode="ko" name="중간"/>
					<nls description="Gemiddeld" languageCode="nl" name="Gemiddeld"/>
					<nls description="Middels" languageCode="no" name="Middels"/>
					<nls description="Średni" languageCode="pl" name="Średni"/>
					<nls description="Médio" languageCode="pt" name="Médio"/>
					<nls description="Средний" languageCode="ru" name="Средний"/>
					<nls description="Medel" languageCode="sv" name="Medel"/>
					<nls description="Orta" languageCode="tr" name="Orta"/>
					<nls description="中" languageCode="zh" name="中"/>
					<nls description="中" languageCode="zh_TW" name="中"/>
				</lookupValue>
				<lookupValue code="CAL_HIGH" sortOrder="3" status="active">
					<nls description="Alt" languageCode="ca" name="Alt"/>
					<nls description="Vysoké" languageCode="cs" name="Vysoké"/>
					<nls description="Høj" languageCode="da" name="Høj"/>
					<nls description="Hoch" languageCode="de" name="Hoch"/>
					<nls description="High" languageCode="en" name="High"/>
					<nls description="Alto" languageCode="es" name="Alto"/>
					<nls description="Korkea" languageCode="fi" name="Korkea"/>
					<nls description="Elevé(e)" languageCode="fr" name="Elevé(e)"/>
					<nls description="Magas" languageCode="hu" name="Magas"/>
					<nls description="Alta" languageCode="it" name="Alta"/>
					<nls description="高" languageCode="ja" name="高"/>
					<nls description="높음" languageCode="ko" name="높음"/>
					<nls description="Hoog" languageCode="nl" name="Hoog"/>
					<nls description="Høy" languageCode="no" name="Høy"/>
					<nls description="Wysoki" languageCode="pl" name="Wysoki"/>
					<nls description="Alto" languageCode="pt" name="Alto"/>
					<nls description="Высокий" languageCode="ru" name="Высокий"/>
					<nls description="Hög" languageCode="sv" name="Hög"/>
					<nls description="Yüksek" languageCode="tr" name="Yüksek"/>
					<nls description="高" languageCode="zh" name="高"/>
					<nls description="高" languageCode="zh_TW" name="高"/>
				</lookupValue>
				<displayedSuggestionAttributes>
					<displayedSuggestionAttribute value="name"/>
				</displayedSuggestionAttributes>
				<searchedSuggestionAttributes>
					<searchedSuggestionAttribute value="name"/>
				</searchedSuggestionAttributes>
			</staticLookup>
		</lookups>
	</contentPack>
</NikuDataBus>